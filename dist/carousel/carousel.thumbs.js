/*! License details at fancyapps.com/license */
import{isPlainObject as t}from"../utils/isPlainObject.js";import{extend as e}from"../utils/extend.js";import{replaceAll as n}from"../utils/replaceAll.js";import{clamp as o}from"../utils/clamp.js";import{Sync as i}from"./carousel.sync.js";import{Lazyload as r}from"./carousel.lazyload.js";import{addClass as l}from"../utils/addClass.js";const s={Carousel:{Lazyload:{showLoading:!1}},minCount:2,showOnStart:!0,thumbTpl:'<button aria-label="Slide to #{{page}}"><img draggable="false" alt="{{alt}}" data-lazy-src="{{src}}" /></button>',type:"modern"};let u;const a=()=>{let a,c,d,f,g=0,m=0,h=!0;function v(e){const n=null==a?void 0:a.getOptions().Thumbs;let o=(t(n)?Object.assign(Object.assign({},s),n):s)[e];return o&&"function"==typeof o&&a?o(a):o}function p(){if(!a)return!1;if(!1===(null==a?void 0:a.getOptions().Thumbs))return!1;let t=0;for(const e of a.getSlides())e.thumbSrc&&t++;return t>=v("minCount")}function b(){return"modern"===v("type")}function y(){return"scrollable"===v("type")}function x(){const t=[],e=(null==a?void 0:a.getSlides())||[];for(const n of e)t.push({index:n.index,html:S(n)});return t}function S(t){const e=t.thumb?t.thumb instanceof HTMLImageElement?t.thumb.src:t.thumb:t.thumbSrc||void 0,o=void 0===t.thumbAlt?`Thumbnail #${t.index}`:t.thumbAlt+"";let i=v("thumbTpl");return i=n(i,"{{alt}}",o),i=n(i,"{{src}}",e+""),i=n(i,"{{index}}",`${t.index}`),i=n(i,"{{page}}",`${t.index||1}`),i}function C(t=!1){var e;const n=null==a?void 0:a.getContainer();if(!a||!n||d)return;if(!p())return;const o=(null===(e=v("Carousel"))||void 0===e?void 0:e.classes)||{};if(o.container=o.container||"f-thumbs",!d){const t=n.nextElementSibling;(null==t?void 0:t.classList.contains(o.container))&&(d=t)}if(!d){d=document.createElement("div");const t=v("parentEl");t?t.insertAdjacentElement("beforeend",d):n.insertAdjacentElement("afterend",d)}l(d,o.container),l(d,"f-thumbs"),l(d,`is-${v("type")}`),t&&l(d,"is-hidden")}function L(){if(!d||!y())return;f=document.createElement("div"),l(f,"f-thumbs__viewport");let t="";for(const e of x()){const n=e.html||"";"string"==typeof n&&(t+=`<div index="${e.index}" class="f-thumbs__slide">${n}</div>`)}f.innerHTML=t,d.append(f),d.addEventListener("click",(t=>{t.preventDefault();const e=t.target.closest("[index]"),n=parseInt((null==e?void 0:e.getAttribute("index"))||"-1");a&&n>-1&&a.goTo(n)}));const e=new IntersectionObserver((t=>{t.forEach((t=>{t.isIntersecting&&t.target instanceof HTMLImageElement&&(t.target.src=t.target.getAttribute("data-lazy-src")+"",t.target.removeAttribute("data-lazy-src"),e.unobserve(t.target))}))}),{root:f,rootMargin:"100px"});d.querySelectorAll("[data-lazy-src]").forEach((t=>{e.observe(t)})),null==a||a.emit("thumbs:ready")}function T(){var t;if(!u||!a||!d||y()||c)return;const n=x();if(!n.length)return;const o=e({},{Sync:{target:a},Lazyload:{preload:1},slides:n,classes:{container:"f-thumbs",viewport:"f-thumbs__viewport",slide:"f-thumbs__slide"},center:!0,fill:!b(),infinite:!1,dragFree:!0,rtl:a.getOptions().rtl||!1,slidesPerPage:t=>{let e=0;return b()&&(!function(){if(!b())return;if(!d)return;const t=t=>d&&parseFloat(getComputedStyle(d).getPropertyValue("--f-thumb-"+t))||0;g=t("width"),m=t("clip-width")}(),e=4*(g-m)),t&&t.getTotalSlideDim()<=t.getViewportDim()-e?1/0:1}},s.Carousel||{},v("Carousel")||{});c=u(d,o,{Sync:i,Lazyload:r}),c.on("ready",(()=>{l(d,"is-syncing"),null==a||a.emit("thumbs:ready"),b()&&(null==a||a.on("render",j))})),c.on("destroy",(()=>{null==a||a.emit("thumbs:destroy")})),c.init(),null===(t=c.getGestures())||void 0===t||t.on("start",(()=>{h=!1})),c.on("click",((t,e)=>{const n=e.target;if(n){const t=n.matches("button")?n:n.firstElementChild;t&&t.matches("button")&&(e.preventDefault(),t.focus({preventScroll:!0}))}})),l(a.getContainer(),"has-thumbs"),_()}function E(){p()&&v("showOnStart")&&(C(),L())}function P(){var t;p()&&(T(),null==a||a.on("addSlide",M),null==a||a.on("click",O),null==a||a.on("refresh",$),null===(t=null==a?void 0:a.getGestures())||void 0===t||t.on("start",w),z())}function w(){var t,e;h=!0;(null===(t=document.activeElement)||void 0===t?void 0:t.closest(".f-thumbs"))&&(null===(e=document.activeElement)||void 0===e||e.blur())}function j(){var t,e;null==d||d.classList.toggle("is-syncing",!1===(null==a?void 0:a.hasNavigated())||(null===(t=null==a?void 0:a.getTween())||void 0===t?void 0:t.isRunning())),_(),(null===(e=null==a?void 0:a.getGestures())||void 0===e?void 0:e.isPointerDown())&&function(){if(!b())return;if(!a||!c)return;if(!h)return;const t=c.getTween(),e=c.getPages(),n=a.getPageIndex()||0,i=a.getPageProgress()||0;if(!(a&&e&&e[n]&&t))return;const r=t.isRunning()?t.getCurrentValues().pos:c.getPosition();if(void 0===r)return;let l=e[n].pos+i*(g-m);l=o(e[0].pos,l,e[e.length-1].pos),t.from({pos:r}).to({pos:l}).start()}()}function A(){h=!0,z()}function M(t,e){null==c||c.add({html:S(e)},e.index)}function O(t,e){const n=e.target;n&&!e.defaultPrevented&&"toggle"===n.dataset.thumbsAction&&(d||(C(!0),L(),T()),d&&d.classList.toggle("is-hidden"))}function $(){z()}function z(){if(!a||!f||!y())return;const t=a.getPageIndex();f.querySelectorAll(".is-selected").forEach((t=>{t.classList.remove("is-selected")}));const e=f.querySelector(`[index="${t}"]`);if(e){e.classList.add("is-selected");const t=f.getBoundingClientRect(),n=e.getBoundingClientRect(),o=e.offsetTop-f.offsetTop-.5*t.height+.5*n.height,i=e.scrollLeft-f.scrollLeft-.5*t.width+.5*n.width;f.scrollTo({top:o,left:i,behavior:"smooth"})}}function _(){if(!b())return;if(!a||!c)return;const t=(null==c?void 0:c.getSlides())||[];let e=-.5*g;for(const n of t){const t=n.el;if(!t)continue;let o=a.getPageProgress(n.index)||0;o=Math.max(-1,Math.min(1,o)),o>-1&&o<1&&(e+=.5*g*(1-Math.abs(o))),o=Math.round(1e4*o)/1e4,e=Math.round(1e4*e)/1e4,t.style.setProperty("--progress",`${Math.abs(o)}`),t.style.setProperty("--shift",`${(null==a?void 0:a.isRTL())?-1*e:e}px`),o>-1&&o<1&&(e+=.5*g*(1-Math.abs(o)))}}return{init:function(t,e){u=e,a=t,a.on("ready",P),a.on("initSlides",E),a.on("change",A)},destroy:function(){var t,e;y()&&(null==a||a.emit("thumbs:destroy")),null==a||a.off("ready",P),null==a||a.off("initSlides",E),null==a||a.off("change",A),null==a||a.off("render",j),null==a||a.off("addSlide",M),null==a||a.off("click",O),null==a||a.off("refresh",$),null===(t=null==a?void 0:a.getGestures())||void 0===t||t.off("start",w),null===(e=null==a?void 0:a.getContainer())||void 0===e||e.classList.remove("has-thumbs"),a=void 0,null==c||c.destroy(),c=void 0,null==d||d.remove(),d=void 0},getCarousel:function(){return c},getContainer:function(){return d},getType:function(){return v("type")},isEnabled:p}};export{a as Thumbs};
